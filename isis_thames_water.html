<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>River ¬∑ Thames Water Customer Assistant</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Outfit:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --blue:      #0077B6;
    --blue-d:    #005f94;
    --blue-l:    #00A8E0;
    --blue-pale: #EAF5FB;
    --blue-mid:  #C2E0F0;
    --teal:      #0096C7;
    --off:       #F0F7FC;
    --ink:       #0F2334;
    --dim:       #3B5A72;
    --muted:     #7A9DB5;
    --border:    #D4E9F5;
    --shadow:    rgba(0,119,182,0.12);
    --font-head: 'DM Serif Display', Georgia, serif;
    --font-body: 'Outfit', sans-serif;
    --font-mono: 'DM Mono', monospace;
  }

  html, body { height: 100%; font-family: var(--font-body); background: var(--off); color: var(--ink); overflow: hidden; }

  .app {
    display: grid;
    grid-template-columns: 300px 1fr;
    height: 100vh;
  }

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  .sidebar {
    background: linear-gradient(170deg, #004f7c 0%, #0077B6 55%, #00A8E0 100%);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
  }

  .sidebar::before {
    content: '';
    position: absolute;
    inset: 0;
    background:
      radial-gradient(ellipse 140% 70% at 50% 110%, rgba(0,168,224,0.35) 0%, transparent 60%),
      url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    pointer-events: none;
  }

  .sidebar-top { padding: 32px 28px 24px; position: relative; }

  .water-logo { display: flex; align-items: center; gap: 10px; margin-bottom: 32px; }

  .water-logo-icon {
    width: 38px; height: 38px;
    background: rgba(255,255,255,0.15);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.2);
  }
  .water-logo-icon svg { width: 20px; height: 20px; }

  .water-logo-text { font-size: 13px; font-weight: 700; color: rgba(255,255,255,0.9); letter-spacing: 0.02em; line-height: 1.2; }
  .water-logo-text span { display: block; font-weight: 400; font-size: 10px; color: rgba(255,255,255,0.55); letter-spacing: 0.06em; text-transform: uppercase; }

  .river-profile { text-align: center; padding: 20px 20px 26px; }

  .river-avatar { width: 88px; height: 88px; margin: 0 auto 14px; position: relative; }

  .river-avatar-ring {
    width: 88px; height: 88px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.05));
    border: 2px solid rgba(255,255,255,0.25);
    display: flex; align-items: center; justify-content: center;
    position: relative;
  }
  .river-avatar-ring::after {
    content: '';
    position: absolute; inset: -4px;
    border-radius: 50%;
    border: 1.5px solid rgba(255,255,255,0.15);
  }

  .river-emoji { font-size: 40px; line-height: 1; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.2)); }

  .online-dot {
    width: 14px; height: 14px;
    background: #34d399;
    border-radius: 50%;
    border: 2.5px solid rgba(0,80,130,0.8);
    position: absolute; bottom: 3px; right: 3px;
    animation: pulse-dot 2s infinite;
  }

  @keyframes pulse-dot {
    0%   { box-shadow: 0 0 0 0 rgba(52,211,153,0.5); }
    70%  { box-shadow: 0 0 0 6px rgba(52,211,153,0); }
    100% { box-shadow: 0 0 0 0 rgba(52,211,153,0); }
  }

  .river-name { font-family: var(--font-head); font-size: 26px; color: #fff; margin-bottom: 4px; }
  .river-title { font-size: 12px; color: rgba(255,255,255,0.6); font-weight: 400; letter-spacing: 0.04em; text-transform: uppercase; }

  .sidebar-divider { height: 1px; background: rgba(255,255,255,0.12); margin: 0 24px; }

  .quick-label { padding: 20px 28px 10px; font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.45); text-transform: uppercase; letter-spacing: 0.1em; }

  .quick-actions { padding: 0 16px; display: flex; flex-direction: column; gap: 6px; flex: 1; }

  .quick-btn {
    display: flex; align-items: center; gap: 12px;
    padding: 11px 14px;
    background: rgba(255,255,255,0.07);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    color: rgba(255,255,255,0.85);
    font-family: var(--font-body);
    font-size: 13px; font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left; width: 100%;
    backdrop-filter: blur(4px);
  }
  .quick-btn:hover { background: rgba(255,255,255,0.14); border-color: rgba(255,255,255,0.22); transform: translateX(3px); color: #fff; }

  .quick-btn-icon { font-size: 18px; flex-shrink: 0; width: 28px; text-align: center; }
  .quick-btn-text { line-height: 1.25; }
  .quick-btn-text small { display: block; font-size: 10px; color: rgba(255,255,255,0.45); font-weight: 400; margin-top: 1px; }

  /* ‚îÄ‚îÄ n8n status badge ‚Äî replaces API key section ‚îÄ‚îÄ */
  .sidebar-footer {
    padding: 16px 16px 20px;
    margin-top: 8px;
  }

  .n8n-badge {
    display: flex; align-items: center; gap: 10px;
    background: rgba(0,0,0,0.2);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 12px 14px;
    backdrop-filter: blur(8px);
  }

  .n8n-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #34d399;
    flex-shrink: 0;
    box-shadow: 0 0 0 0 rgba(52,211,153,0.5);
    animation: pulse-dot 2s infinite;
  }

  .n8n-info { flex: 1; min-width: 0; }
  .n8n-info strong { display: block; font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.9); margin-bottom: 2px; }
  .n8n-info span { font-size: 10px; color: rgba(255,255,255,0.45); font-family: var(--font-mono); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

  /* ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ */
  .chat-area { display: flex; flex-direction: column; height: 100vh; background: var(--off); }

  .chat-header {
    background: #fff;
    border-bottom: 1px solid var(--border);
    padding: 16px 28px;
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0;
    box-shadow: 0 1px 8px var(--shadow);
    z-index: 10;
  }

  .chat-header-left { display: flex; align-items: center; gap: 12px; }

  .chat-header-avatar {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--blue-l), var(--blue));
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }

  .chat-header-name { font-family: var(--font-head); font-size: 20px; color: var(--ink); line-height: 1; }
  .chat-header-status { font-size: 12px; color: #34d399; font-weight: 500; display: flex; align-items: center; gap: 4px; margin-top: 2px; }
  .chat-header-status::before { content: '‚óè'; font-size: 8px; }

  .chat-header-right { display: flex; gap: 8px; }

  .icon-btn {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; font-size: 15px;
  }
  .icon-btn:hover { background: var(--blue-pale); color: var(--blue); border-color: var(--blue-mid); }

  .messages {
    flex: 1; overflow-y: auto;
    padding: 28px 32px;
    display: flex; flex-direction: column;
    gap: 20px;
    scroll-behavior: smooth;
  }
  .messages::-webkit-scrollbar { width: 4px; }
  .messages::-webkit-scrollbar-thumb { background: var(--blue-mid); border-radius: 2px; }

  .welcome-card {
    background: linear-gradient(135deg, var(--blue) 0%, var(--teal) 100%);
    border-radius: 20px;
    padding: 32px;
    color: #fff;
    position: relative; overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,119,182,0.3);
    animation: fadeSlide 0.5s ease both;
  }
  .welcome-card::before { content: ''; position: absolute; top: -30%; right: -10%; width: 200px; height: 200px; border-radius: 50%; background: rgba(255,255,255,0.07); pointer-events: none; }

  .welcome-greeting { font-family: var(--font-head); font-size: 28px; margin-bottom: 8px; position: relative; }
  .welcome-body { font-size: 14px; color: rgba(255,255,255,0.85); line-height: 1.6; position: relative; }

  .welcome-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 20px; position: relative; }

  .welcome-chip {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 999px;
    padding: 6px 14px;
    font-size: 12px; font-weight: 500; color: #fff;
    cursor: pointer; transition: all 0.2s;
    backdrop-filter: blur(4px);
    font-family: var(--font-body);
  }
  .welcome-chip:hover { background: rgba(255,255,255,0.28); transform: translateY(-1px); }

  .msg { display: flex; gap: 12px; animation: fadeSlide 0.3s ease both; max-width: 80%; }
  .msg.user { align-self: flex-end; flex-direction: row-reverse; }
  .msg.bot  { align-self: flex-start; }

  @keyframes fadeSlide { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

  .msg-avatar {
    width: 36px; height: 36px;
    border-radius: 50%; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 17px; align-self: flex-end;
  }
  .msg.bot .msg-avatar  { background: linear-gradient(135deg, var(--blue-l), var(--blue)); box-shadow: 0 2px 8px rgba(0,119,182,0.25); }
  .msg.user .msg-avatar { background: var(--ink); color: #fff; font-size: 12px; font-weight: 700; font-family: var(--font-body); }

  .msg-bubble { padding: 14px 18px; border-radius: 18px; font-size: 14px; line-height: 1.65; max-width: 100%; }
  .msg.bot .msg-bubble  { background: #fff; color: var(--ink); border-bottom-left-radius: 4px; box-shadow: 0 2px 12px var(--shadow); border: 1px solid var(--border); }
  .msg.user .msg-bubble { background: linear-gradient(135deg, var(--blue), var(--teal)); color: #fff; border-bottom-right-radius: 4px; box-shadow: 0 2px 12px rgba(0,119,182,0.3); }

  .msg-time { font-size: 10px; color: var(--muted); margin-top: 4px; }
  .msg.bot  .msg-time { text-align: left;  margin-left: 48px; }
  .msg.user .msg-time { text-align: right; }

  .typing-indicator { display: flex; gap: 12px; align-items: flex-end; animation: fadeSlide 0.3s ease both; }
  .typing-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--blue-l), var(--blue)); display: flex; align-items: center; justify-content: center; font-size: 17px; flex-shrink: 0; }
  .typing-bubble { background: #fff; border: 1px solid var(--border); border-radius: 18px; border-bottom-left-radius: 4px; padding: 14px 18px; display: flex; gap: 5px; align-items: center; box-shadow: 0 2px 12px var(--shadow); }
  .typing-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--blue-l); animation: bounce 1.2s infinite; }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce { 0%,60%,100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-6px); opacity: 1; } }

  .input-area { background: #fff; border-top: 1px solid var(--border); padding: 16px 28px 20px; flex-shrink: 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.04); }

  .input-wrap {
    display: flex; align-items: flex-end; gap: 10px;
    background: var(--off);
    border: 1.5px solid var(--border);
    border-radius: 16px;
    padding: 10px 10px 10px 18px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .input-wrap:focus-within { border-color: var(--blue-l); box-shadow: 0 0 0 3px rgba(0,168,224,0.1); }

  .chat-input { flex: 1; background: none; border: none; outline: none; font-family: var(--font-body); font-size: 14px; color: var(--ink); resize: none; max-height: 120px; line-height: 1.5; padding: 4px 0; }
  .chat-input::placeholder { color: var(--muted); }

  .send-btn { width: 40px; height: 40px; border-radius: 12px; background: var(--blue); border: none; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,119,182,0.4); }
  .send-btn:hover:not(:disabled) { background: var(--blue-d); transform: scale(1.05); }
  .send-btn:disabled { background: var(--blue-mid); cursor: not-allowed; box-shadow: none; transform: none; }
  .send-btn svg { width: 18px; height: 18px; }

  .input-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }

  .input-hints { display: flex; gap: 8px; flex-wrap: wrap; }

  .hint-chip { background: var(--blue-pale); border: 1px solid var(--blue-mid); color: var(--blue); border-radius: 999px; padding: 3px 10px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.15s; font-family: var(--font-body); }
  .hint-chip:hover { background: var(--blue-mid); }

  .powered-by { font-size: 11px; color: var(--muted); white-space: nowrap; }
  .powered-by strong { color: var(--dim); }

  .error-banner { background: #FEE2E2; border: 1px solid #FECACA; border-radius: 10px; padding: 12px 16px; color: #991B1B; font-size: 13px; animation: fadeSlide 0.3s ease both; }

  @media(max-width:700px) { .app { grid-template-columns: 1fr; } .sidebar { display: none; } .messages { padding: 16px; } .input-area { padding: 12px 16px 16px; } .msg { max-width: 92%; } }

  * { scrollbar-width: thin; scrollbar-color: var(--blue-mid) transparent; }
</style>
</head>
<body>
<div class="app">

  <!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
  <aside class="sidebar">
    <div class="sidebar-top">

      <div class="water-logo">
        <div class="water-logo-icon">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 2C12 2 4 9.5 4 14.5C4 18.64 7.58 22 12 22C16.42 22 20 18.64 20 14.5C20 9.5 12 2 12 2Z" fill="white" opacity="0.9"/>
            <path d="M8 15.5C8 15.5 9 18 12 18C15 18 16 15.5 16 15.5" stroke="rgba(0,119,182,0.6)" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="water-logo-text">
          Thames Water
          <span>Customer Support</span>
        </div>
      </div>

      <div class="river-profile">
        <div class="river-avatar">
          <div class="river-avatar-ring">
            <span class="river-emoji">üíß</span>
          </div>
          <div class="online-dot"></div>
        </div>
        <div class="river-name">River</div>
        <div class="river-title">Digital Front Desk Assistant</div>
      </div>
    </div>

    <div class="sidebar-divider"></div>
    <div class="quick-label">Quick Actions</div>

    <div class="quick-actions">
      <button class="quick-btn" onclick="sendQuick('I need to report a leak')">
        <span class="quick-btn-icon">üö∞</span>
        <span class="quick-btn-text">Report a Leak<small>Emergency &amp; routine reports</small></span>
      </button>
      <button class="quick-btn" onclick="sendQuick('I have a question about my bill')">
        <span class="quick-btn-icon">üìÑ</span>
        <span class="quick-btn-text">Bill &amp; Payments<small>Queries, disputes, direct debit</small></span>
      </button>
      <button class="quick-btn" onclick="sendQuick('I need help with my account')">
        <span class="quick-btn-icon">üë§</span>
        <span class="quick-btn-text">Account Management<small>Details, passwords, moving home</small></span>
      </button>
      <button class="quick-btn" onclick="sendQuick('I have a concern about water quality')">
        <span class="quick-btn-icon">üî¨</span>
        <span class="quick-btn-text">Water Quality<small>Discolouration, odour, taste</small></span>
      </button>
      <button class="quick-btn" onclick="sendQuick('Is there a water outage in my area?')">
        <span class="quick-btn-icon">‚ö°</span>
        <span class="quick-btn-text">Service Outages<small>Check your area for disruptions</small></span>
      </button>
      <button class="quick-btn" onclick="sendQuick('I would like to schedule a business meeting')">
        <span class="quick-btn-icon">üìÖ</span>
        <span class="quick-btn-text">Book a Meeting<small>Business &amp; commercial enquiries</small></span>
      </button>
    </div>

    <!-- n8n connected badge ‚Äî replaces API key section -->
    <div class="sidebar-footer">
      <div class="n8n-badge">
        <div class="n8n-dot"></div>
        <div class="n8n-info">
          <strong>Connected to n8n</strong>
          <span>arie08.app.n8n.cloud</span>
        </div>
      </div>
    </div>
  </aside>

  <!-- ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ -->
  <main class="chat-area">

    <div class="chat-header">
      <div class="chat-header-left">
        <div class="chat-header-avatar">üíß</div>
        <div>
          <div class="chat-header-name">River</div>
          <div class="chat-header-status">Online ¬∑ Powered by n8n</div>
        </div>
      </div>
      <div class="chat-header-right">
        <button class="icon-btn" title="New conversation" onclick="clearChat()">üóë</button>
        <button class="icon-btn" title="Download transcript" onclick="downloadChat()">‚¨á</button>
      </div>
    </div>

    <div class="messages" id="messages">
      <div class="welcome-card">
        <div class="welcome-greeting">Hello! I'm River üëã</div>
        <div class="welcome-body">
          Welcome to Thames Water Customer Support. I'm your digital assistant here to help with leaks, billing, account queries, water quality concerns, and more. How can I help you today?
        </div>
        <div class="welcome-chips">
          <button class="welcome-chip" onclick="sendQuick('I need to report a leak or burst pipe')">üö∞ Report a leak</button>
          <button class="welcome-chip" onclick="sendQuick('Why is my bill higher than usual?')">üìÑ Billing query</button>
          <button class="welcome-chip" onclick="sendQuick('My water looks discoloured')">üî¨ Water quality</button>
          <button class="welcome-chip" onclick="sendQuick('Is there a planned outage in my area?')">‚ö° Check outages</button>
        </div>
      </div>
    </div>

    <div class="input-area">
      <div class="input-wrap">
        <textarea
          class="chat-input"
          id="chatInput"
          rows="1"
          placeholder="Type your message‚Ä¶"
          onkeydown="handleKey(event)"
          oninput="autoResize(this)"
        ></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
      <div class="input-footer">
        <div class="input-hints">
          <button class="hint-chip" onclick="sendQuick('How do I submit a meter reading?')">Meter reading</button>
          <button class="hint-chip" onclick="sendQuick('How do I set up a payment plan?')">Payment plan</button>
          <button class="hint-chip" onclick="sendQuick('I am moving home')">Moving home</button>
        </div>
        <div class="powered-by">Powered by <strong>n8n &amp; OpenAI</strong></div>
      </div>
    </div>

  </main>
</div>

<script>
// ‚îÄ‚îÄ n8n WEBHOOK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const N8N_WEBHOOK = 'https://arie08.app.n8n.cloud/webhook/a4e65857-86c4-4753-8365-ff29a75d60bb/chat';

// Unique session ID ‚Äî keeps n8n memory scoped to this browser session
let sessionId = 'river-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8);
let isLoading = false;
let chatLog   = [];

// ‚îÄ‚îÄ SEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendMessage() {
  const input = document.getElementById('chatInput');
  const text  = input.value.trim();
  if (!text || isLoading) return;

  input.value = '';
  autoResize(input);

  appendMessage('user', text);
  chatLog.push({ role: 'user', content: text, time: new Date() });

  showTyping();
  isLoading = true;
  document.getElementById('sendBtn').disabled = true;

  try {
    const res = await fetch(N8N_WEBHOOK, {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify({ chatInput: text, sessionId })
    });

    hideTyping();

    if (!res.ok) {
      const body = await res.text().catch(() => '');
      appendError(`Connection error (${res.status})${body ? ' ‚Äî ' + body.slice(0, 120) : ''}. Please try again.`);
      return;
    }

    const data  = await res.json();
    // n8n chat trigger returns { output: "..." } ‚Äî fallback handles older configs
    const reply = data?.output
               || data?.text
               || data?.message
               || data?.response
               || (typeof data === 'string' ? data : null)
               || "Sorry, I didn't receive a response. Please try again.";

    chatLog.push({ role: 'river', content: reply, time: new Date() });
    appendMessage('bot', reply);

  } catch (err) {
    hideTyping();
    appendError('Could not reach the River service. Please check your connection.');
    console.error(err);
  } finally {
    isLoading = false;
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('chatInput').focus();
  }
}

function sendQuick(text) {
  document.getElementById('chatInput').value = text;
  sendMessage();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function appendMessage(role, text) {
  const msgs = document.getElementById('messages');
  const now  = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + role;

  const avatar = document.createElement('div');
  avatar.className = 'msg-avatar';
  avatar.textContent = role === 'bot' ? 'üíß' : 'You';

  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  bubble.innerHTML = formatMessage(text);

  const timeEl = document.createElement('div');
  timeEl.className = 'msg-time';
  timeEl.textContent = now;

  const body = document.createElement('div');
  body.style.cssText = 'display:flex;flex-direction:column;min-width:0';
  body.appendChild(bubble);
  body.appendChild(timeEl);

  if (role === 'bot') { wrapper.appendChild(avatar); wrapper.appendChild(body); }
  else                { wrapper.appendChild(body);   wrapper.appendChild(avatar); }

  msgs.appendChild(wrapper);
  msgs.scrollTop = msgs.scrollHeight;
}

function formatMessage(text) {
  return text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/`(.*?)`/g, '<code style="background:#f0f4f8;padding:1px 5px;border-radius:4px;font-family:\'DM Mono\',monospace;font-size:12px">$1</code>')
    .replace(/\n\n/g, '</p><p style="margin-top:8px">')
    .replace(/\n/g, '<br>')
    .replace(/^/, '<p>').replace(/$/, '</p>')
    .replace(/(0800\s?\d{3}\s?\d{4})/g, '<a href="tel:$1" style="color:var(--blue);font-weight:600;text-decoration:none">üìû $1</a>');
}

function appendError(msg) {
  const msgs = document.getElementById('messages');
  const div  = document.createElement('div');
  div.className = 'error-banner';
  div.textContent = '‚ö†Ô∏è ' + msg;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

// ‚îÄ‚îÄ TYPING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTyping() {
  const msgs = document.getElementById('messages');
  const el   = document.createElement('div');
  el.className = 'typing-indicator';
  el.id = 'typingIndicator';
  el.innerHTML = `
    <div class="typing-avatar">üíß</div>
    <div class="typing-bubble">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>`;
  msgs.appendChild(el);
  msgs.scrollTop = msgs.scrollHeight;
}

function hideTyping() {
  const el = document.getElementById('typingIndicator');
  if (el) el.remove();
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function clearChat() {
  if (!confirm('Start a new conversation?')) return;
  // New session ID resets n8n memory for this user
  sessionId = 'river-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8);
  chatLog   = [];
  const msgs = document.getElementById('messages');
  [...msgs.children].slice(1).forEach(c => c.remove());
}

function downloadChat() {
  if (!chatLog.length) { alert('No conversation to download yet.'); return; }
  const lines = chatLog.map(m =>
    `[${m.time.toLocaleTimeString('en-GB')}] ${m.role.toUpperCase()}\n${m.content}`
  ).join('\n\n---\n\n');
  const date = new Date().toISOString().slice(0, 10);
  const blob = new Blob([`Thames Water ¬∑ River Transcript ¬∑ ${date}\n\n${lines}`], { type: 'text/plain' });
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(blob);
  a.download = `river-transcript-${date}.txt`;
  a.click();
}
</script>
</body>
</html>
